const poly = require('polyapi');
const { CloudEvent } = require('cloudevents');

const handle = async (context, body) => {
  const POLY_USER_SESSION_ID = context.headers['openai-conversation-id'];
  const args = context.cloudevent ? [body.data] : body.args;

  if (context.cloudevent) {
    context.log.info(`Received cloudevent: id=${context.cloudevent.id}, time=${context.cloudevent.time}, type=${context.cloudevent.type}, source=${context.cloudevent.source}`);
  }

  {{{code}}}

  try {
    const result = await {{name}}(...args);

    if (context.cloudevent) {
      const executionId = context.cloudevent.executionid;
      if (executionId) {
        context.log.info('Returning CloudEvent...', CloudEvent);
        return new CloudEvent({
          source: context.cloudevent.source,
          type: 'trigger.response',
          data: {
            data: result,
            executionId: executionId
          }
        });
      } else {
        return {
          statusCode: 204
        };
      }
    } else {
      return {
        body: result
      };
    }
  } catch (e) {
    return {
      body: {
        message: e.message,
        stack: e.stack
      },
      statusCode: 500
    };
  }
}

module.exports = handle;
