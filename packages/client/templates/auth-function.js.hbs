const axios = require('axios');

module.exports = function(eventsClientId, getSocket, clientId, clientSecret, {{#if audienceRequired}}audience, scopes, callback, { callbackUrl, timeout = 0 } = {}{{else}}scopes, callback, { audience, callbackUrl, timeout = 0 } = {}{{/if}}) {
  axios.post(`{{apiBaseUrl}}/functions/auth/{{id}}/execute`, { eventsClientId, clientId, clientSecret, scopes, audience, callbackUrl }, { headers: { 'X-PolyApiKey': '{{apiKey}}' }})
    .then(({ data }) => {
      callback(data.token, data.url, data.error);
      if (data.token) {
        return;
      }

      let timeoutID;
      const socket = getSocket();
      const unregisterEventHandler = () => {
        socket.off(`handleAuthFunctionEvent:{{id}}`);
        socket.emit('unregisterAuthFunctionEventHandler', {
            clientID: eventsClientId,
            functionId: '{{id}}',
            apiKey: '{{apiKey}}'
        });
        if (timeoutID) {
          clearTimeout(timeoutID);
        }
      };
      const handleEvent = ({ token, url, error }) => {
        callback(token, url, error);
      };
      socket.on(`handleAuthFunctionEvent:{{id}}`, handleEvent);
      socket.emit('registerAuthFunctionEventHandler', {
        clientID: eventsClientId,
        functionId: '{{id}}',
        apiKey: '{{apiKey}}'
      });

      if (timeout) {
        timeoutID = setTimeout(() => unregisterEventHandler(), timeout);
        callback(null, null, { message: 'Timeout reached' });
      }
    });

  return {
    revoke: () => axios.post(`{{apiBaseUrl}}/functions/auth/{{id}}/revoke`, { clientId, clientSecret }, { headers: { 'X-PolyApiKey': '{{apiKey}}' }}),
  };
}
