const axios = require('../axios');

module.exports = function(eventsClientId, getSocket, clientId, clientSecret, {{#if audienceRequired}}audience, scopes, callback, { callbackUrl, timeout = 120000, autoCloseOnToken = true, userId } = {}{{else}}scopes, callback, { audience, callbackUrl, timeout = 120000, autoCloseOnToken = true, userId } = {}{{/if}}) {
  if (userId) {
    eventsClientId = `${eventsClientId}-${userId}`;
  }

  let socket = null;
  let timeoutID = null;

  const unregisterEventHandler = () => {
    if (!socket) {
      return;
    }
    socket.off(`handleAuthFunctionEvent:ee35849b-e40b-4f8a-bcb3-da4e1134f219`);
    socket.emit('unregisterAuthFunctionEventHandler', {
      clientID: eventsClientId,
      functionId: 'ee35849b-e40b-4f8a-bcb3-da4e1134f219',
      apiKey: 'ptab4f62d3421bca3674hfd627',
    });
    if (timeoutID) {
      clearTimeout(timeoutID);
    }
  };

  axios.post(`/auth-providers/{{id}}/execute`, { eventsClientId, clientId, clientSecret, scopes, audience, callbackUrl, userId })
    .then(({ data }) => {
      if (data.token) {
        callback(data.token, data.url, data.error);
        return;
      }
      socket = getSocket();
      const handleEvent = ({ token, url, error }) => {
        callback(token, url, error);
        if (token && autoCloseOnToken) {
          unregisterEventHandler();
        }
      };
      socket.emit('registerAuthFunctionEventHandler', {
        clientID: eventsClientId,
        functionId: '{{id}}',
        apiKey: '{{apiKey}}'
      }, registered => {
        if (registered) {
          socket.on(`handleAuthFunctionEvent:{{id}}`, handleEvent);
          callback(data.token, data.url, data.error);
        }
      });

      if (timeout) {
        timeoutID = setTimeout(() => {
          unregisterEventHandler();
          callback(null, null, { message: 'Timeout reached' });
        }, timeout);
      }
    });

  return {
    revoke: () => axios.post(`/functions/auth/{{id}}/revoke`, { clientId, clientSecret }),
    close: () => unregisterEventHandler(),
  };
}
