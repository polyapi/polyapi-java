const set = require('lodash/set');
const merge = require('lodash/merge');
const { io } = require("socket.io-client");
const { v4: uuidv4 } = require('uuid');
const urlFunctions = require('./url');
const customFunctions = require('./custom');
const authFunctions = require('./auth');
const serverFunctions = require('./server');

const clientID = uuidv4();
let socket = null;
const getSocket = () => {
  if (!socket) {
    socket = io('{{apiBaseUrl}}/events');
  }
  return socket;
};

const webhookHandles = [
{{#each webhookHandles}}
  {{#if context}}
    ['{{context}}.{{name}}', '{{id}}'],
  {{else}}
    ['{{name}}', '{{id}}'],
  {{/if}}
{{/each}}
];

const errorHandler = {
  on: (path, callback) => {
    const socket = getSocket();
    socket.emit('registerErrorHandler', {
      clientID,
      path,
      apiKey: '{{apiKey}}'
    });
    socket.on(`handleError:${path}`, callback);
  },
  off: (path) => {
    const socket = getSocket();
    socket.emit('unregisterErrorHandler', {
      clientID,
      path,
      apiKey: '{{apiKey}}'
    });
  }
};

const registerWebhookEventListener = (webhookHandleID, callback) => {
  const socket = getSocket();
  socket.emit('registerWebhookEventHandler', {
    clientID,
    webhookHandleID,
    apiKey: '{{apiKey}}'
  });
  socket.on(`handleWebhookEvent:${webhookHandleID}`, callback);

  return () => {
    socket.emit('unregisterWebhookEventHandler', {
      clientID,
      webhookHandleID,
      apiKey: '{{apiKey}}'
    });
  }
};

const poly = {};
module.exports = merge(
  poly,
  urlFunctions(clientID),
  customFunctions(poly),
  serverFunctions(clientID),
  authFunctions(clientID, getSocket),
  webhookHandles.reduce(
    (acc, [path, id]) => set(acc, path, (callback) => registerWebhookEventListener(id, callback)),
    {}
  ),
  {
    errorHandler
  }
);
