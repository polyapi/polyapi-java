const axios = require('axios');
const set = require('lodash/set');
const merge = require('lodash/merge');
const { io } = require("socket.io-client");
const { v4: uuidv4 } = require('uuid');
const customFunctions = require('./custom');

const clientID = uuidv4();
let socket = null;
const getSocket = () => {
  if (!socket) {
    socket = io('{{apiBaseUrl}}/events');
  }
  return socket;
};

const functions = [
{{#each functions}}
  {{#if context}}
  ['{{context}}.{{name}}', '{{id}}'],
  {{else}}
  ['{{name}}', '{{id}}'],
  {{/if}}
{{/each}}
];

const webhookHandles = [
{{#each webhookHandles}}
  {{#if context}}
    ['{{context}}.{{name}}', '{{id}}'],
  {{else}}
    ['{{name}}', '{{id}}'],
  {{/if}}
{{/each}}
];

const errorHandler = {
  on: (path, callback) => {
    const socket = getSocket();
    socket.emit('registerErrorHandler', {
      clientID,
      path,
      apiKey: '{{apiKey}}'
    });
    socket.on(`handleError:${path}`, callback);
  },
  off: (path) => {
    const socket = getSocket();
    socket.emit('unregisterErrorHandler', {
      clientID,
      path,
      apiKey: '{{apiKey}}'
    });
  }
};

const registerWebhookEventListener = (webhookHandleID, callback) => {
  const socket = getSocket();
  socket.emit('registerWebhookEventHandler', {
    clientID,
    webhookHandleID,
    apiKey: '{{apiKey}}'
  });
  socket.on(`handleWebhookEvent:${webhookHandleID}`, callback);

  return () => {
    socket.emit('unregisterWebhookEventHandler', {
      clientID,
      webhookHandleID,
      apiKey: '{{apiKey}}'
    });
  }
};

const poly = {};
module.exports = merge(
  poly,
  functions.reduce(
    (acc, [path, id]) => set(acc, path, (...args) => axios.post(`{{apiBaseUrl}}/functions/execute/${id}`, { clientID, args }).then(({ data }) => data)),
    {}
  ),
  customFunctions(poly),
  webhookHandles.reduce(
    (acc, [path, id]) => set(acc, path, (callback) => registerWebhookEventListener(id, callback)),
    {}
  ),
  {
    errorHandler
  }
);
