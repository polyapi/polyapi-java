const set = require('lodash/set');
const merge = require('lodash/merge');
const { io } = require("socket.io-client");
const { v4: uuidv4 } = require('uuid');
const apiFunctions = require('./api');
const customFunctions = require('./custom');
const webhookHandles = require('./webhook-handles');
const authFunctions = require('./auth');
const serverFunctions = require('./server');

const clientID = uuidv4();
let socket = null;
const getSocket = () => {
  if (!socket) {
    socket = io('{{apiBaseUrl}}/events');
  }
  return socket;
};

const errorHandler = {
  on: (path, callback) => {
    const socket = getSocket();
    socket.emit('registerErrorHandler', {
      clientID,
      path,
      apiKey: '{{apiKey}}'
    });
    socket.on(`handleError:${path}`, callback);
  },
  off: (path) => {
    const socket = getSocket();
    socket.emit('unregisterErrorHandler', {
      clientID,
      path,
      apiKey: '{{apiKey}}'
    });
  }
};

const poly = {};
module.exports = merge(
  poly,
  apiFunctions(clientID),
  customFunctions(poly),
  serverFunctions(clientID),
  authFunctions(clientID, getSocket),
  webhookHandles(clientID, getSocket),
  {
    errorHandler
  }
);
