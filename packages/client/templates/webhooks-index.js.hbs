const set = require('lodash/set');
const merge = require('lodash/merge');

const webhookHandles = [
{{#each specifications}}
  {{#if context}}
    ['{{context}}.{{name}}', '{{id}}'],
  {{else}}
    ['{{name}}', '{{id}}'],
  {{/if}}
{{/each}}
];

const registerWebhookEventListener = (clientID, getSocket, getApiKey, webhookHandleID, callback) => {
  const socket = getSocket();
  socket.emit('registerWebhookEventHandler', {
    clientID,
    webhookHandleID,
    apiKey: getApiKey(),
  }, registered => {
    if (registered) {
      socket.on(
        `handleWebhookEvent:${webhookHandleID}`,
        ({ body, headers, params }) => callback(body, headers, params)
      );
    } else {
      console.log(`Could not register webhook event handler for ${webhookHandleID}`);
    }
  });

  return () => {
    socket.emit('unregisterWebhookEventHandler', {
      clientID,
      webhookHandleID,
      apiKey: getApiKey(),
    });
  }
};

module.exports = (clientID, getSocket, getApiKey) => merge(
  {},
  webhookHandles.reduce(
    (acc, [path, id]) => set(acc, path, (callback) => registerWebhookEventListener(clientID, getSocket, getApiKey, id, callback)),
    {}
  ),
);
